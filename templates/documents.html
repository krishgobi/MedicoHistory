<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='documents.css') }}">
</head>
<body>
    <div class="sidebar">
        <ul>
            <li onclick="window.location.href='{{ url_for('dashboard') }}'">Home</li>
            <li onclick="window.location.href='{{ url_for('subject_history_page') }}'">History</li>
            <li onclick="window.location.href='{{ url_for('important') }}'">Important</li>
        </ul>
    </div>
    <div class="container">
        <h2>Subject-wise Documents</h2>
        <form id="addSubjectForm">
            <input type="text" id="subjectName" placeholder="Enter Subject Name" required>
            <button type="submit">Add Subject</button>
        </form>
        <ul id="subjectList"></ul>
        <div id="fileSection" style="display:none; margin-top:32px;">
            <h3 id="selectedSubject"></h3>
            <form id="addFileForm">
                <input type="text" id="fileLabel" placeholder="File Name" required>
                <input type="file" id="fileInput" required>
                <button type="submit">Add File</button>
            </form>
            <ul id="fileList"></ul>
        </div>
    </div>
    <script>
        // LocalStorage keys
        const SUBJECTS_KEY = 'doc_subjects';
        const FILES_KEY_PREFIX = 'doc_files_';
        let currentSubject = null;
        function getSubjects() {
            return JSON.parse(localStorage.getItem(SUBJECTS_KEY) || '[]');
        }
        function setSubjects(subjects) {
            localStorage.setItem(SUBJECTS_KEY, JSON.stringify(subjects));
        }
        function getFiles(subject) {
            return JSON.parse(localStorage.getItem(FILES_KEY_PREFIX + subject) || '[]');
        }
        function setFiles(subject, files) {
            localStorage.setItem(FILES_KEY_PREFIX + subject, JSON.stringify(files));
        }
        function renderSubjects() {
            const subjects = getSubjects();
            const ul = document.getElementById('subjectList');
            ul.innerHTML = '';
            subjects.forEach(subj => {
                const li = document.createElement('li');
                const nameBtn = document.createElement('button');
                nameBtn.textContent = subj;
                nameBtn.style.flex = '1';
                nameBtn.onclick = () => selectSubject(subj);
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.className = 'delete-btn';
                delBtn.onclick = () => { if(confirm('Delete this subject and all its files?')) { deleteSubject(subj); } };
                li.appendChild(nameBtn);
                li.appendChild(delBtn);
                ul.appendChild(li);
            });
        }
        function selectSubject(subj) {
            currentSubject = subj;
            document.getElementById('fileSection').style.display = '';
            document.getElementById('selectedSubject').textContent = 'Files for: ' + subj;
            renderFiles(subj);
        }
        function deleteSubject(subj) {
            let subjects = getSubjects();
            subjects = subjects.filter(s => s !== subj);
            setSubjects(subjects);
            localStorage.removeItem(FILES_KEY_PREFIX + subj);
            if(currentSubject === subj) {
                document.getElementById('fileSection').style.display = 'none';
                currentSubject = null;
            }
            renderSubjects();
        }
        function renderFiles(subj) {
            const files = getFiles(subj);
            const ul = document.getElementById('fileList');
            ul.innerHTML = '';
            files.forEach((file, idx) => {
                const li = document.createElement('li');
                const name = document.createElement('span');
                name.textContent = file.label;
                const openBtn = document.createElement('button');
                openBtn.textContent = 'Open';
                openBtn.className = 'open-btn';
                openBtn.onclick = () => { const win = window.open(); win.document.write(`<iframe src='${file.data}' width='100%' height='100%'></iframe>`); };
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.className = 'delete-btn';
                delBtn.onclick = () => { if(confirm('Delete this file?')) { deleteFile(subj, idx); } };
                li.appendChild(name);
                li.appendChild(openBtn);
                li.appendChild(delBtn);
                ul.appendChild(li);
            });
        }
        function deleteFile(subj, idx) {
            let files = getFiles(subj);
            files.splice(idx, 1);
            setFiles(subj, files);
            renderFiles(subj);
        }
        document.getElementById('addSubjectForm').onsubmit = function(e) {
            e.preventDefault();
            const subj = document.getElementById('subjectName').value.trim();
            if(!subj) return;
            let subjects = getSubjects();
            if(subjects.includes(subj)) { alert('Subject already exists!'); return; }
            subjects.push(subj);
            setSubjects(subjects);
            document.getElementById('subjectName').value = '';
            renderSubjects();
        };
        document.getElementById('addFileForm').onsubmit = function(e) {
            e.preventDefault();
            if(!currentSubject) return;
            const label = document.getElementById('fileLabel').value.trim();
            const fileInput = document.getElementById('fileInput');
            if(!label || !fileInput.files.length) return;
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(ev) {
                let files = getFiles(currentSubject);
                files.push({ label: label, data: ev.target.result });
                setFiles(currentSubject, files);
                renderFiles(currentSubject);
            };
            reader.readAsDataURL(file);
            document.getElementById('fileLabel').value = '';
            fileInput.value = '';
        };
        renderSubjects();
    </script>
</body>
</html>
